const N={player:"#2563eb",ai:"#dc2626",neutral:"#9ca3af"},A="#0f172a";function d(f,e,t,n){const i=f-t,o=e-n;return Math.hypot(i,o)}function y(f,e,t){return Math.max(e,Math.min(t,f))}class P{canvas;ctx;config;hudElements;nodes=new Map;links=new Map;outgoingByNode=new Map;incomingByNode=new Map;pointer={x:0,y:0,hoverNode:null,dragSource:null,isDragging:!1};accumulator=0;lastTimestamp=0;animationFrame=0;paused=!1;winner=null;lastCreatedLink=null;tutorialShown=!1;aiCooldown=0;initialLevel;constructor(e,t,n,i){const o=e.getContext("2d");if(!o)throw new Error("Canvas 2D context not available.");this.canvas=e,this.ctx=o,this.hudElements=t,this.initialLevel=n,this.config=i,this.canvas.width=n.width,this.canvas.height=n.height,this.hudElements.title.textContent="Flowgrid â€” Level 1",this.hudElements.legend.innerHTML='<span class="player">Player</span><span class="ai">AI</span><span class="neutral">Neutral</span>',this.resetState(),this.registerInput(),this.start()}start(){this.lastTimestamp=performance.now(),this.animationFrame=requestAnimationFrame(this.loop)}loop=e=>{const t=(e-this.lastTimestamp)/1e3;if(this.lastTimestamp=e,!this.paused&&!this.winner){this.accumulator+=t;const n=this.config.fixedStep;for(;this.accumulator>=n;)this.update(n),this.accumulator-=n}this.render(),this.animationFrame=requestAnimationFrame(this.loop)};resetState(){this.nodes.clear(),this.links.clear(),this.outgoingByNode.clear(),this.incomingByNode.clear(),this.lastCreatedLink=null,this.pointer={x:0,y:0,hoverNode:null,dragSource:null,isDragging:!1},this.accumulator=0,this.lastTimestamp=performance.now(),this.paused=!1,this.winner=null,this.aiCooldown=0;for(const e of this.initialLevel.nodes){const t={...e,energy:e.energy,outgoingLimit:this.config.outgoingLimit,safetyReserve:this.config.safetyReserve};this.nodes.set(t.id,t)}for(const e of this.nodes.values())this.outgoingByNode.set(e.id,[]),this.incomingByNode.set(e.id,[]);this.hudElements.prompt.textContent="Drag from a blue node to capture neutrals. Right-click links to remove.",this.hudElements.pauseIndicator.style.display="none",this.hudElements.endScreen.style.display="none",this.tutorialShown=!1}registerInput(){this.canvas.addEventListener("pointermove",e=>{const t=this.canvas.getBoundingClientRect();this.pointer.x=(e.clientX-t.left)/t.width*this.canvas.width,this.pointer.y=(e.clientY-t.top)/t.height*this.canvas.height,this.pointer.hoverNode=this.hitTestNode(this.pointer.x,this.pointer.y)}),this.canvas.addEventListener("pointerdown",e=>{if(e.button===2){this.deleteLinkAtPointer();return}if(e.button!==0)return;const t=this.pointer.hoverNode;t&&t.owner==="player"&&(this.pointer.dragSource=t,this.pointer.isDragging=!0,this.tutorialShown||(this.hudElements.prompt.textContent="Shorter routes are more efficient.",this.tutorialShown=!0))}),this.canvas.addEventListener("pointerup",e=>{if(e.button===0){if(this.pointer.isDragging&&this.pointer.dragSource){const t=this.hitTestNode(this.pointer.x,this.pointer.y);t&&t.id!==this.pointer.dragSource.id&&this.createLink(this.pointer.dragSource.id,t.id)}this.pointer.dragSource=null,this.pointer.isDragging=!1}}),this.canvas.addEventListener("pointerleave",()=>{this.pointer.hoverNode=null,this.pointer.dragSource=null,this.pointer.isDragging=!1}),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("keydown",e=>{if(e.key===" "){e.preventDefault(),this.togglePause();return}if(e.key==="r"||e.key==="R"){this.restart();return}if(this.lastCreatedLink){const t=this.config.sharePresets[e.key];typeof t=="number"&&this.applySharePreset(this.lastCreatedLink,t)}}),this.hudElements.restartButton.addEventListener("click",()=>this.restart())}togglePause(){this.paused=!this.paused,this.hudElements.pauseIndicator.style.display=this.paused?"block":"none",this.hudElements.pauseIndicator.textContent="Paused"}restart(){this.resetState()}hitTestNode(e,t){for(const n of Array.from(this.nodes.values()).reverse())if(d(e,t,n.x,n.y)<=n.radius+6)return n;return null}deleteLinkAtPointer(){let e=null;for(const t of this.links.values()){if(t.owner!=="player")continue;const n=this.nodes.get(t.sourceId),i=this.nodes.get(t.targetId);if(!n||!i)continue;const o=(n.x+i.x)/2,r=(n.y+i.y)/2,l=d(this.pointer.x,this.pointer.y,o,r);l<18&&(!e||l<e.dist)&&(e={link:t,dist:l})}e&&this.removeLink(e.link.id)}createLink(e,t){const n=this.nodes.get(e),i=this.nodes.get(t);if(!n||!i||this.winner||n.owner!=="player"&&n.owner!=="ai"||n.owner==="player"&&this.winner||n.owner==="player"&&this.paused||e===t||this.links.has(`${e}->${t}`)||d(n.x,n.y,i.x,i.y)>this.config.maxLinkDistance)return;const o=this.outgoingByNode.get(e);if(!o||o.length>=n.outgoingLimit)return;const r=d(n.x,n.y,i.x,i.y),l=y(1-r*this.config.distanceLoss,this.config.efficiencyFloor,1),s={id:`${e}->${t}`,sourceId:e,targetId:t,share:1,length:r,efficiency:l,owner:n.owner,maxRate:this.config.linkMaxRate,smoothedRate:0};this.links.set(s.id,s),o.push(s),this.incomingByNode.get(t)?.push(s);const a=this.outgoingByNode.get(e)??[],u=1/a.length;for(const p of a)p.share=u;s.share=u,this.lastCreatedLink=s}applySharePreset(e,t){const n=this.outgoingByNode.get(e.sourceId);if(!n||!n.includes(e))return;const i=n.reduce((s,a)=>a===e?s:s+a.share,0),o=Math.max(0,1-i),r=y(t,.05,1);e.share=Math.min(r,o);const l=n.reduce((s,a)=>s+a.share,0);if(l>1){const s=1/l;for(const a of n)a.share*=s}}removeLink(e){const t=this.links.get(e);if(!t)return;const n=this.outgoingByNode.get(t.sourceId);if(n){const o=n.indexOf(t);o>=0&&n.splice(o,1);const r=n.length;if(r>0){const l=1/r;for(const s of n)s.share=l}}const i=this.incomingByNode.get(t.targetId);if(i){const o=i.indexOf(t);o>=0&&i.splice(o,1)}this.links.delete(e),this.lastCreatedLink?.id===e&&(this.lastCreatedLink=null)}update(e){for(const n of this.nodes.values())n.energy=Math.min(n.capacity,n.energy+n.regen*e);const t={};for(const[n,i]of this.outgoingByNode){const o=this.nodes.get(n);if(!o||i.length===0||o.energy<=o.safetyReserve)continue;const r=Math.max(0,o.energy-o.safetyReserve);if(r<=0)continue;const l=i.reduce((s,a)=>s+a.share,0);if(!(l<=0))for(const s of i){const a=s.share/l,u=r*a,p=Math.min(s.maxRate,u),m=p*e;if(m<=0)continue;o.energy=Math.max(0,o.energy-m);const S=m*s.efficiency,c=this.nodes.get(s.targetId);c&&(c.owner===s.owner?c.energy=Math.min(c.capacity,c.energy+S):(c.energy=Math.max(0,c.energy-S),t[c.id]=s.owner),s.smoothedRate=s.smoothedRate*.8+p*.2)}}for(const n of this.nodes.values())if(n.energy<=0){const i=t[n.id];i&&this.captureNode(n,i)}this.aiCooldown-=e,this.aiCooldown<=0&&!this.winner&&(this.runAiTurn(),this.aiCooldown=.35),this.checkVictory()}captureNode(e,t){e.owner=t,e.energy=this.config.captureSeed;const n=this.outgoingByNode.get(e.id)??[];for(const i of[...n])this.removeLink(i.id)}runAiTurn(){const e=Array.from(this.nodes.values()).filter(t=>t.owner==="ai");for(const t of e){const n=t.energy-t.safetyReserve;if(n<this.config.surplusThreshold){this.trimAiLinksIfWeak(t);continue}if((this.outgoingByNode.get(t.id)??[]).length>=t.outgoingLimit)continue;const o=Array.from(this.nodes.values()).filter(s=>s.id!==t.id&&d(s.x,s.y,t.x,t.y)<=this.config.maxLinkDistance).sort((s,a)=>d(t.x,t.y,s.x,s.y)-d(t.x,t.y,a.x,a.y));let r=null;const l=o.filter(s=>s.owner==="neutral"&&s.energy<n);if(l.length>0&&(r=l[0]),!r){const s=o.filter(a=>a.owner==="player").sort((a,u)=>a.energy-u.energy);s.length>0&&(r=s[0])}r&&this.createLink(t.id,r.id)}}trimAiLinksIfWeak(e){const t=this.outgoingByNode.get(e.id);if(!t||t.length===0||e.energy>e.safetyReserve+5)return;let n=null;for(const i of t)(!n||i.length>n.length)&&(n=i);n&&this.removeLink(n.id)}checkVictory(){if(Array.from(this.nodes.values()).every(n=>n.owner==="player")){this.setWinner("player");return}Array.from(this.nodes.values()).every(n=>n.owner==="ai")&&this.setWinner("ai")}setWinner(e){this.winner=e,this.paused=!0,this.hudElements.endScreen.style.display="flex",this.hudElements.endHeadline.textContent=e==="player"?"Network Secured":"Network Compromised"}render(){const e=this.ctx;e.clearRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#f6f3ef",e.fillRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.links.values()){const n=this.nodes.get(t.sourceId),i=this.nodes.get(t.targetId);if(!n||!i)continue;const o=N[t.owner];e.strokeStyle=o;const r=2+y(t.smoothedRate/t.maxRate,0,1)*6;e.lineWidth=r,e.lineCap="round",e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(i.x,i.y),e.stroke()}this.pointer.isDragging&&this.pointer.dragSource&&(e.strokeStyle="#64748b",e.lineWidth=2,e.setLineDash([6,6]),e.beginPath(),e.moveTo(this.pointer.dragSource.x,this.pointer.dragSource.y),e.lineTo(this.pointer.x,this.pointer.y),e.stroke(),e.setLineDash([]));for(const t of this.nodes.values()){const n=N[t.owner];e.fillStyle="#f1ece6",e.beginPath(),e.arc(t.x,t.y,t.radius+4,0,Math.PI*2),e.fill(),e.strokeStyle=t.owner==="player"?A:"#1f2933",e.lineWidth=this.pointer.hoverNode?.id===t.id?3:1.5,e.beginPath(),e.arc(t.x,t.y,t.radius+1,0,Math.PI*2),e.stroke(),e.fillStyle=n,e.beginPath(),e.arc(t.x,t.y,t.radius,0,Math.PI*2),e.fill();const i=y(t.energy/t.capacity,0,1),o=t.radius-4;e.fillStyle="rgba(255,255,255,0.85)",e.beginPath(),e.arc(t.x,t.y,o,0,Math.PI*2),e.fill(),e.fillStyle=n,e.globalAlpha=.85,e.beginPath(),e.arc(t.x,t.y,o*i,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.fillStyle="#1f2933",e.font='12px "Inter", "Segoe UI", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillText(Math.round(t.energy).toString(),t.x,t.y)}}}const T={id:"flowgrid-level-1",width:1280,height:720,seed:1337,nodes:[{id:"n1",x:260,y:360,owner:"player",energy:80,capacity:110,regen:7,radius:18},{id:"n2",x:380,y:220,owner:"player",energy:70,capacity:110,regen:6,radius:16},{id:"n3",x:560,y:160,owner:"neutral",energy:60,capacity:100,regen:6,radius:16},{id:"n4",x:620,y:340,owner:"neutral",energy:65,capacity:100,regen:6,radius:16},{id:"n5",x:540,y:520,owner:"neutral",energy:70,capacity:100,regen:6,radius:16},{id:"n6",x:760,y:240,owner:"neutral",energy:65,capacity:100,regen:6,radius:16},{id:"n7",x:860,y:420,owner:"neutral",energy:70,capacity:100,regen:6,radius:16},{id:"n8",x:980,y:280,owner:"ai",energy:80,capacity:110,regen:7,radius:18},{id:"n9",x:1060,y:520,owner:"ai",energy:70,capacity:110,regen:6,radius:16}]},C=document.querySelector("#app");if(!C)throw new Error("App root not found");const h=document.createElement("div");h.className="game-container";C.appendChild(h);const E=document.createElement("canvas");h.appendChild(E);const x=document.createElement("div");x.className="hud";h.appendChild(x);const R=document.createElement("div");x.appendChild(R);const w=document.createElement("div");w.className="pause-indicator";h.appendChild(w);const v=document.createElement("div");v.className="legend";h.appendChild(v);const k=document.createElement("div");k.className="prompt";h.appendChild(k);const g=document.createElement("div");g.className="end-screen";const M=document.createElement("h1"),L=document.createElement("button");L.textContent="Restart";g.appendChild(M);g.appendChild(L);g.style.display="none";h.appendChild(g);const b={fixedStep:1/60,maxLinkDistance:380,distanceLoss:.001,efficiencyFloor:.35,captureSeed:20,safetyReserve:10,outgoingLimit:3,linkMaxRate:20,surplusThreshold:20,sharePresets:{1:.25,2:.5,3:1}};new P(E,{title:R,legend:v,prompt:k,pauseIndicator:w,endScreen:g,endHeadline:M,restartButton:L},T,b);
